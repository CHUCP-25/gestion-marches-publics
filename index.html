<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SITUATION GLOBALE DES MARCHÉS 2025</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #1e3a8a;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f1f5f9;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background-color: var(--bg); margin: 0; padding: 15px; }

        .main-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 96vh;
        }

        /* Barre d'outils supérieure */
        .toolbar {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e2e8f0;
            gap: 15px;
        }

        .btn-group { display: flex; gap: 8px; }
        
        .btn {
            padding: 9px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            color: white;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: 0.2s;
        }
        .btn-add { background: var(--primary); }
        .btn-import { background: var(--warning); }
        .btn-excel { background: #166534; }
        .btn-pdf { background: #991b1b; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* Ligne de recherche et pagination fusionnée */
        .search-nav-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .search-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
        }

        .search-group input {
            flex-grow: 1;
            padding: 8px 15px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 13px;
            max-width: 600px;
        }

        .pagination-group {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #64748b;
        }

        .pagination-group select {
            padding: 5px;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
        }

        .status-sync {
            font-size: 12px;
            color: var(--success);
            font-weight: 500;
        }

        /* Double Barre de défilement supérieure */
        .top-scroll-wrapper {
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            height: 14px;
            background: #e2e8f0;
        }
        .top-scroll-content { height: 1px; }

        /* Tableau */
        .table-area { overflow: auto; flex-grow: 1; }
        table { border-collapse: collapse; width: max-content; font-size: 12px; }
        
        th {
            background: #1e293b;
            color: white;
            padding: 12px 10px;
            position: sticky;
            top: 0;
            z-index: 10;
            border: 1px solid #334155;
            text-transform: uppercase;
        }

        td { padding: 6px; border: 1px solid #e2e8f0; background: white; }

        /* Colonnes */
        .col-id { min-width: 200px; } 
        .col-objet { min-width: 450px; }
        .col-date { min-width: 150px; }
        .col-action { min-width: 100px; text-align: center; } 

        input, select, textarea { 
            width: 100%; 
            border: 1px solid #d1d5db; 
            border-radius: 4px; 
            padding: 5px;
            background: transparent;
        }
        input:focus, textarea:focus { background: #fff; border-color: var(--primary); outline: none; }
        input:disabled { background: #f1f5f9; cursor: not-allowed; }

        .icon-btn {
            font-size: 18px;
            cursor: pointer;
            margin: 0 5px;
            border: none;
            background: none;
            transition: 0.2s;
        }
        .icon-save { color: var(--success); }
        .icon-delete { color: var(--danger); }
        .icon-btn:hover { transform: scale(1.2); }
    </style>
</head>
<body>

<div class="main-container">
    <div class="toolbar">
        <div class="btn-group">
            <button class="btn btn-add" onclick="addNewRow()">
                <i class="fas fa-plus"></i> Nouveau Marché
            </button>
            <button class="btn btn-import" onclick="document.getElementById('importFile').click()">
                <i class="fas fa-file-import"></i> Importer
            </button>
            <input type="file" id="importFile" hidden accept=".xlsx, .xls" onchange="importExcel(this)">
            <button class="btn btn-excel" onclick="exportExcel()">
                <i class="fas fa-file-excel"></i> Excel
            </button>
            <button class="btn btn-pdf" onclick="exportPDF()">
                <i class="fas fa-file-pdf"></i> PDF
            </button>
        </div>
        <div class="status-sync" id="saveStatus">
            <i class="fas fa-check-circle"></i> Connecté à Firebase
        </div>
    </div>

    <div class="search-nav-bar">
        <div class="pagination-group">
            <span>Afficher</span>
            <select id="pageSize" onchange="changeLimit()">
                <option value="20">20</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="500">500</option>
            </select>
            <span>lignes</span>
        </div>

        <div class="search-group">
            <i class="fas fa-search" style="color: #94a3b8; margin-right: -35px; z-index: 1;"></i>
            <input type="text" id="globalSearch" placeholder="Rechercher par société, type (MDD/Invest), visa (Requis/Non), objet..." onkeyup="smartSearch()" style="padding-left: 40px;">
        </div>
    </div>

    <div class="top-scroll-wrapper" id="topScroll">
        <div class="top-scroll-content" id="topScrollContent"></div>
    </div>

    <div class="table-area" id="tableWrapper">
        <table id="mainTable">
            <thead>
                <tr>
                    <th>EXERCICE</th>
                    <th class="col-id">N° DAO</th>
                    <th class="col-id">N° de marché</th>
                    <th class="col-objet">Objet</th>
                    <th>ESTIMATION (DH)</th>
                    <th class="col-date">Réc. besoins</th>
                    <th class="col-date">Envoi DAO</th>
                    <th class="col-date">Ouv. plis</th>
                    <th class="col-date">Fin travaux</th>
                    <th>STATUT</th>
                    <th>SOCIETE</th>
                    <th>TYPE</th>
                    <th>Montant retenu</th>
                    <th>Délai</th>
                    <th>VISA REQUIS</th>
                    <th class="col-id">N° DE VISA</th>
                    <th class="col-date">DATE VISA</th>
                    <th class="col-date">APPROBATION</th>
                    <th class="col-date">NOTIF. APPROB.</th>
                    <th class="col-date">COMMENCEMENT</th>
                    <th class="col-date">ARRET</th>
                    <th class="col-date">REPRISE</th>
                    <th class="col-objet">OBSERVATION</th>
                    <th class="col-action">ACTION</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    // CONFIGURATION FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyCH3-BrjT_M8hNXwTW0sxBKY6E8t0UDxy4",
        authDomain: "gestion-marches-publics.firebaseapp.com",
        projectId: "gestion-marches-publics",
        storageBucket: "gestion-marches-publics.firebasestorage.app",
        messagingSenderId: "308165477195",
        appId: "1:308165477195:web:64d1f1c4d0e17158459ece"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Synchro Scrolls
    const tableWrapper = document.getElementById('tableWrapper');
    const topScroll = document.getElementById('topScroll');
    const topScrollContent = document.getElementById('topScrollContent');
    tableWrapper.onscroll = () => topScroll.scrollLeft = tableWrapper.scrollLeft;
    topScroll.onscroll = () => tableWrapper.scrollLeft = topScroll.scrollLeft;

    function refreshScroll() {
        topScrollContent.style.width = document.getElementById('mainTable').scrollWidth + "px";
    }

    let currentLimit = 20;

    function addNewRow(data = {}, id = null) {
        const tbody = document.getElementById('tableBody');
        const tr = document.createElement('tr');
        if(id) tr.dataset.id = id;

        const vDisabled = data.vReq === "visa non requi" || !data.vReq;

        tr.innerHTML = `
            <td><input type="number" class="f-exercice" value="${data.exercice || 2025}" onchange="autoSave(this)"></td>
            <td><input type="text" class="f-dao" value="${data.dao || ''}" onchange="autoSave(this)"></td>
            <td><input type="text" class="f-marche" value="${data.marche || ''}" onchange="autoSave(this)"></td>
            <td><textarea class="f-objet" rows="2" onchange="autoSave(this)">${data.objet || ''}</textarea></td>
            <td><input type="number" class="f-est" value="${data.est || ''}" onchange="autoSave(this)"></td>
            <td><input type="date" class="f-dB" value="${data.dB || ''}" onchange="autoSave(this)"></td>
            <td><input type="date" class="f-dE" value="${data.dE || ''}" onchange="autoSave(this)"></td>
            <td><input type="date" class="f-dP" value="${data.dP || ''}" onchange="autoSave(this)"></td>
            <td><input type="date" class="f-dF" value="${data.dF || ''}" onchange="autoSave(this)"></td>
            <td>
                <select class="f-statut" onchange="autoSave(this)">
                    <option ${data.statut === 'EN COURS' ? 'selected' : ''}>EN COURS</option>
                    <option ${data.statut === 'MARCHE ATTRIBUE' ? 'selected' : ''}>MARCHE ATTRIBUE</option>
                    <option ${data.statut === 'INFRUCTUEUX' ? 'selected' : ''}>INFRUCTUEUX</option>
                    <option ${data.statut === 'ANNULE' ? 'selected' : ''}>ANNULE</option>
                </select>
            </td>
            <td><input type="text" class="f-soc" value="${data.soc || ''}" onchange="autoSave(this)"></td>
            <td>
                <select class="f-type" onchange="autoSave(this)">
                    <option value="MDD" ${data.type === 'MDD' ? 'selected' : ''}>MDD</option>
                    <option value="invest" ${data.type === 'invest' ? 'selected' : ''}>Investissement</option>
                </select>
            </td>
            <td><input type="number" class="f-mnt" value="${data.mnt || ''}" onchange="autoSave(this)"></td>
            <td><input type="text" class="f-delai" value="${data.delai || ''}" onchange="autoSave(this)"></td>
            <td>
                <select class="f-vReq" onchange="toggleVisa(this); autoSave(this)">
                    <option value="visa non requi" ${data.vReq === 'visa non requi' ? 'selected' : ''}>visa non requi</option>
                    <option value="visa requi" ${data.vReq === 'visa requi' ? 'selected' : ''}>visa requi</option>
                </select>
            </td>
            <td><input type="text" class="f-vN" value="${data.vN || ''}" ${vDisabled ? 'disabled' : ''} onchange="autoSave(this)"></td>
            <td><input type="date" class="f-vD" value="${data.vD || ''}" ${vDisabled ? 'disabled' : ''} onchange="autoSave(this)"></td>
            <td><input type="date" class="f-dAppr" value="${data.dAppr || ''}" onchange="autoSave(this)"></td>
            <td><input type="date" class="f-dNot" value="${data.dNot || ''}" onchange="autoSave(this)"></td>
            <td><input type="date" class="f-dCom" value="${data.dCom || ''}" onchange="autoSave(this)"></td>
            <td><input type="date" class="f-dArr" value="${data.dArr || ''}" onchange="autoSave(this)"></td>
            <td><input type="date" class="f-dRep" value="${data.dRep || ''}" onchange="autoSave(this)"></td>
            <td><textarea class="f-obs" rows="2" onchange="autoSave(this)">${data.obs || ''}</textarea></td>
            <td class="col-action">
                <button class="icon-btn icon-save" onclick="saveRow(this)" title="Sauvegarder"><i class="fas fa-save"></i></button>
                <button class="icon-btn icon-delete" onclick="deleteRow(this)" title="Supprimer"><i class="fas fa-trash-alt"></i></button>
            </td>
        `;
        tbody.prepend(tr);
        refreshScroll();
    }

    function toggleVisa(el) {
        const row = el.closest('tr');
        const disable = el.value === "visa non requi";
        row.querySelector('.f-vN').disabled = disable;
        row.querySelector('.f-vD').disabled = disable;
    }

    async function loadData() {
        const snap = await db.collection('marches').orderBy('exercice', 'desc').limit(currentLimit).get();
        document.getElementById('tableBody').innerHTML = '';
        snap.forEach(doc => addNewRow(doc.data(), doc.id));
        refreshScroll();
    }

    async function autoSave(el) {
        document.getElementById('saveStatus').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Synchronisation...';
        await saveRow(el, true);
        setTimeout(() => {
            document.getElementById('saveStatus').innerHTML = '<i class="fas fa-check-circle"></i> Données synchronisées';
        }, 800);
    }

    async function saveRow(el, silent = false) {
        const row = el.closest('tr');
        const data = {
            exercice: row.querySelector('.f-exercice').value,
            dao: row.querySelector('.f-dao').value,
            marche: row.querySelector('.f-marche').value,
            objet: row.querySelector('.f-objet').value,
            est: row.querySelector('.f-est').value,
            dB: row.querySelector('.f-dB').value,
            dE: row.querySelector('.f-dE').value,
            dP: row.querySelector('.f-dP').value,
            dF: row.querySelector('.f-dF').value,
            statut: row.querySelector('.f-statut').value,
            soc: row.querySelector('.f-soc').value,
            type: row.querySelector('.f-type').value,
            mnt: row.querySelector('.f-mnt').value,
            delai: row.querySelector('.f-delai').value,
            vReq: row.querySelector('.f-vReq').value,
            vN: row.querySelector('.f-vN').value,
            vD: row.querySelector('.f-vD').value,
            dAppr: row.querySelector('.f-dAppr').value,
            dNot: row.querySelector('.f-dNot').value,
            dCom: row.querySelector('.f-dCom').value,
            dArr: row.querySelector('.f-dArr').value,
            dRep: row.querySelector('.f-dRep').value,
            obs: row.querySelector('.f-obs').value
        };
        
        if(row.dataset.id) {
            await db.collection('marches').doc(row.dataset.id).update(data);
        } else {
            const res = await db.collection('marches').add(data);
            row.dataset.id = res.id;
        }
        if(!silent) alert("Enregistré !");
    }

    function deleteRow(btn) {
        const row = btn.closest('tr');
        if(confirm("Supprimer ce marché ?")) {
            if(row.dataset.id) db.collection('marches').doc(row.dataset.id).delete();
            row.remove();
        }
    }

    // RECHERCHE INTELLIGENTE UNIFIÉE
    function smartSearch() {
        const query = document.getElementById('globalSearch').value.toLowerCase();
        const rows = document.querySelectorAll('#tableBody tr');
        
        rows.forEach(row => {
            // On récupère toutes les valeurs de la ligne pour une recherche globale
            const exercice = row.querySelector('.f-exercice').value;
            const dao = row.querySelector('.f-dao').value.toLowerCase();
            const marche = row.querySelector('.f-marche').value.toLowerCase();
            const objet = row.querySelector('.f-objet').value.toLowerCase();
            const societe = row.querySelector('.f-soc').value.toLowerCase();
            const type = row.querySelector('.f-type').value.toLowerCase();
            const visa = row.querySelector('.f-vReq').value.toLowerCase();
            
            // Si la requête est trouvée dans n'importe quel champ important
            const match = exercice.includes(query) || 
                          dao.includes(query) || 
                          marche.includes(query) || 
                          objet.includes(query) || 
                          societe.includes(query) || 
                          type.includes(query) || 
                          visa.includes(query);
            
            row.style.display = match ? "" : "none";
        });
    }

    function importExcel(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(firstSheet);
            json.forEach(item => addNewRow(item));
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function exportExcel() {
        const wb = XLSX.utils.table_to_book(document.getElementById('mainTable'));
        XLSX.writeFile(wb, "Situation_Globale_Marches.xlsx");
    }

    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', [1200, 600]);
        doc.autoTable({ html: '#mainTable', theme: 'grid' });
        doc.save("Situation_Globale.pdf");
    }

    function changeLimit() {
        currentLimit = parseInt(document.getElementById('pageSize').value);
        loadData();
    }

    window.onload = loadData;
</script>
</body>
</html>
